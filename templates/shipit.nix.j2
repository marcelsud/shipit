{ config, pkgs, ... }:
let
  dockerBin = "${pkgs.docker}/bin/docker";
in
{
  virtualisation.docker.enable = true;
  users.users.{{ user }}.extraGroups = [ "docker" ];
  environment.systemPackages = with pkgs; [ wireguard-tools ];

  systemd.services.traefik = {
    description = "Traefik Reverse Proxy";
    after = [ "docker.service" ];
    requires = [ "docker.service" ];
    wantedBy = [ "multi-user.target" ];
    serviceConfig = {
      Restart = "always";
      ExecStartPre = "-${dockerBin} rm -f traefik";
      ExecStart = "${dockerBin} run --name traefik --rm -p 80:80 -p 443:443 -v /var/run/docker.sock:/var/run/docker.sock:ro -v /etc/traefik/traefik.toml:/etc/traefik/traefik.toml:ro -v /etc/traefik/acme.json:/etc/traefik/acme.json --network traefik traefik:latest";
      ExecStop = "${dockerBin} stop traefik";
    };
  };
}
